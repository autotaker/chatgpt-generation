---
tags: Java CI whi-advent
title: 新卒１年目が荒れ果てた開発環境に１年間でCIを導入し単体テストを布教した話 - 1
---

この記事は [「Develop fun!」を体現する Works Human Intelligence Advent Calendar 2020](https://qiita.com/advent-calendar/2020/whi) 21日目の記事です。

昨日の記事は@sparklingbabyさんの[Stream API がもっとわかる記事](https://qiita.com/sparklingbaby/items/146cafb49ccb0c32ea2f)でした。


# あらすじ

私は2019年にWorks Human Intelligence（正確には分社前の会社）に新卒入社し、
19年10月からプロダクト開発部門に配属され、SETエンジニアとしてとある製品のJava開発環境の改善に取り組んでいます。

ざっくりとプロダクト開発を紹介するとこんな感じです。

- 3万クラス程度ある大規模Java Webアプリケーション
- 開発環境はEclipseを使用
- 開発者のOSはWindowsのみ

## Before

私が開発チームに参加した時点では
部門として新規開発に注力しており、足下の環境改善をやる担当者がおらず、
いろいろな汚れが少しずつ蓄積していた結果、
工数的にも、技術的にも誰も手がつけられない状況になっていました。

具体的にあげると

- 新人が開発環境のセットアップするのに**２日**かかる
- **セットアップを正しく行えていない**開発者が多く、LinterやFormatterの設定がバラバラ
- 推奨設定でセットアップするとIDEのエラー表示タブが**1000件**を超えるLintエラーで溢れて**コンパイルエラーも埋もれてしまう**
- ユニットテストは存在していたが、**メンテが一切されておらず、コンパイルすら通らない。**開発者はテストコードのビルドエラーを無視してローカルでテストを実行する必要がある
- 依存ライブラリの管理を手動で行なっているため、安全なライブラリ更新が**実質不可能**
- プレマージの自動チェックは一切なく、レビュワーの目視のみが頼り。結果、**ビルドが頻繁に落ちる。**
- 大半の開発者はユニットテストを**利用していない**

と言った感じです。なかなかにワイルドな開発者体験だと思いませんか？

そこで、部署に配属された私は、~~この環境で開発やりたくない~~この状況をなんとかしたかったため、
上長と相談して専任で開発環境改善を担当することになりました。

## After
私が１年間改善に取り組んだ結果、以下のようなモダンな開発環境になりました。

- 開発環境のセットアップは大半が自動化され、**2時間以内**で終わるように
- セットアップ自動化により、**全員**が推奨設定で開発環境を利用するように
- フォーマット違反、Lintエラーを**0件に削減**。
- ユニットテストをメンテし、コンパイルエラーを修正し、**動くテスト約2000件を抽出**。（動かないテストは隔離）
- 依存ライブラリ管理をGradleに任せることで、**安全なライブラリ更新が可能に**。
- プレマージでビルド、フォーマッタ、Linter、ユニットテストが自動チェックされるCIを導入。ビルドエラー、Lintエラー、ユニットテスト失敗の**0件維持をCI導入から半年以上達成**。
- 開発者がユニットテストを**コンスタント**に書くように

この記事ではどのように改善を進めていったのかを紹介します。

# ステップ1: 開発環境セットアップ工数の削減 
*退屈なことはPowerShellにやらせよう*

まず、手始めに開発環境セットアップ手順を見直しました。
当時の開発環境構築は**十数ステップ**に渡る手順から構成されており、

- 新人がセットアップを完了するのに**２日**かかる
- 間違いなくセットアップを完了させられる人は**ほぼいない**

と言う状況でした。

## セットアップが複雑な理由
このような長い設定手順になっている原因は大きく２点ありました。
1. デフォルト設定のEclipseに設定を入れていた。
2. 開発に必要なソフトウェアを各自が手動インストールしていた。

## 解決策
１つ目の原因に対しては、ローカル環境に依存しない設定をプリセット[^6]したEclipseを作成し、配布することにしました。

[^6]: Eclipse Pleiadesプラグインを使うとそのようなことができます。

２つ目に対しては、また、開発に必要なソフトウェア一式をサイレントインストールするPowerShellスクリプト[^7]を作成し、自動化しました。

[^7]: Chocolatey等のパッケージマネージャを利用することも検討しましたが、一部の開発者はインターネットアクセスに制限があることから断念しました

## 荒れ果てたソースコード
これで、開発環境のセットアップ工数が大幅に削減され、全員が推奨設定で開発できるようになりました。
しかし、前述の通り、「**推奨設定でセットアップするとIDEのエラー表示タブが1000件を超えるLintエラーで溢れてコンパイルエラーも埋もれてしまう**」という問題があったため、
新しい開発環境への移行前に既存のLintエラーを直す必要がありました。
（なお、ここでいうLintエラーとはEclipseのError/Warning設定で指定するUnused Imports等のエラーのことです）

## 開墾
既存のLintエラーですが、間違った直し方をしてしまうと、大量のデグレードを発生させてしまう恐れがありました。
デグレードは言うまでもなくダメですが、
特に私は新卒１年目で、社内での信頼度はまだ低く、最初のプロジェクトで悪評が立つことは避けなければなりません。

エラーの内容を精査し、

1. QuickFixで一意に直せるもの（Unused Imports, Missing Annotation等）
2. 単純なコードの削除で直せるもの（Unused local variable等）
3. 手動修正が必要なもの

に分類し、1は一括で自動修正し、2についてはコードレビューを実施して削除して問題ないコードかを確認して慎重に修正を行いました。
3については `@SuppressWarnings`アノテーションを付与することで、コードは修正せずにエラーを抑制する対応を取りました。

## 効果
このようにして新しい開発環境への移行を行いました。
結果として以下のような効果が出ました。

- セットアップにかかる工数を２日から2時間に短縮
- 全員が同じ設定で開発できるように
- EclipseのProblems Viewに表示されるLintエラーが０件になり、自分が新たに発生させたコンパイルエラー、Lintエラーに気づくことができるように

開発環境自動化を作成したことで現場からも「セットアップが楽になった」　「開発環境を壊してもすぐ直せるので便利」と言った評判をいただきました。

# ステップ2: プレマージ導入 
*このビルドを落としたのは誰ですか？*

開発環境セットアップ自動化により、全員が推奨設定でIDEを使えるようになったのですが、

以下のような場合にフォーマッタ違反、Lintエラーが混入する可能性がありました。

- 何かの弾みで設定を変えてしまった場合
- 推奨IDEを使わずにコードを修正している場合

このままでは、徐々にエラーが蓄積し、せっかく綺麗にしたソースがまた荒れてしまいます。
それを防ぐためにプレマージでの自動チェックを導入することにしました。


## 目標
プレマージを導入するにあたって、以下の３点に注意して要件を設定しました。

### 1. 待ち時間が妥当でありジョブの待ち行列が詰まらないこと
CIにかけられるマシンリソースはオンプレのメモリ16GBのマシン２台でした。
対象プロダクトのビルドは8GBのメモリが必要で、クリーンビルドすると3分程度かかります。

繁忙期にジョブキューが詰まると、MRの承認に待ち時間がかかり、
場合によってはプレマージを無視してマージするようになってしまいます。

そのようなことを避けるために一回のチェックは**5分以内に終了する**ことを目標にしました。

### 2. エラーがあったときには迅速かつわかりやすく通知され、エラーがないときにはウザくないこと。
プレマージがエラーを検出したとき、最も実装が簡単な通知方法は
「MRのコミットステータスを失敗させ、開発者にジョブのログを確認させる」
というものになるでしょう。

しかし、小規模開発やCIの仕様を開発者全員が知っている場合はこれでも良いですが、
この方法は大規模開発において**迅速かつわかりやすく**とは言えません。

MRの失敗通知はメールで送られてきますが、メールを常時チェックしている人は少ないでしょう。
また、開発者がジョブのログを確認するのも無視できない手間がかかります。
また、ログを読み慣れていない開発者はエラー原因が分からず、CI担当者（私）に問い合わせてくることでしょう。
そうなってしまうと、コミュニケーションコストがかかってくるため、双方が幸せになれません。

今回はエラーの通知方法として
**エラーの箇所をMRのコメントで指摘し、同時にエラーがあったことをSlackに通知する**ようにしました。
また、多数のコミットをpushしたときにMRのコメント欄が読みにくくなるのを防ぐために、コメントをつけるのはエラーを検出したときのみとして、**正常終了した場合はコミットステータスの更新のみ**を行うようにしました。


### 3. 誤検知が少ないこと
プレマージの信頼性は非常に重要です。なぜなら信頼性が低いプレマージはそのうちに無視されるようになるからです。

プレマージのエラー誤検知のパターンは２種類あります。

1. チェック時に実行環境に障害が生じてジョブが失敗する場合
2. 元々存在していて、MR起因ではないエラーを検出した場合

一つ目のパターンはなかなか難しい問題でCIインフラ担当者が頑張る必要がありますが、
大抵は再実行してもらうことでなんとかなります。 

二つ目のパターンをなくすために
「topicブランチのHEADとMerge Baseコミットをそれぞれチェックしてエラーの増分を検出する」
と言う方法を取ることにしました。[^3][^4]


[^3]: ちなみに「修正されたソースコード上のエラーを検出する」という方法もありそうですが、検出すべきエラーを見逃すケースがあるため採用しませんでした。 

[^4]: 「エラーは０件維持されているんだからMerge Baseコミットにエラーはないんじゃないの」と思った方もいるかもしれませんが、開発イテレーション末で0件になっていますが、開発イテレーション中にエラーが混入することは想定する必要があります。また0件維持されていないWarningも同じ仕組みで検出しているためこのようになっています。


※ここでMerge Baseコミットは以下の図のようなものです。
![merge base.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/67228/aff88cfe-3e6e-88f5-2c49-888178706959.png)

## 大規模プロジェクトにおける課題
上記要件を達成するにあたって幾つかの技術的な課題がありました。

* ビルドスクリプトはAntで書かれており、長らく変更されておらずメンテナがいない状態だった。
* フォーマッタおよびLinterはEclipseの付属のもの利用しており、コマンドラインから簡単に実行できない。
* 全クラス（3万程度）をコンパイルするのに3分程度かかる。一方でエラーは変更したソース起因のものだけ表示するためには２回ビルドしなければならず、5分に間に合わせるためには差分ビルドを行う必要がある。

## 解決策
フォーマッタやLinterがEclipseに強く依存していたため、切り出してビルドスクリプトに組み込むのは困難でした。

そこでEclipseをCLIから操作できるようにしようと考え、[Eclipse RCP](https://wiki.eclipse.org/Rich_Client_Platform) として以下の機能を実装しました。

- ビルドしてビルドエラーとLintエラーをCSVに出力する
- 指定したファイルにフォーマッタを適用する

実はEclipse JDTは優秀なのでうまくキャッシュをすると[^1]差分ビルドもしてくれるので結構[^2]高速です。

[^1]: なかなかキャッシュが言うことを聞いてくれないのでJDTの判定ロジックをHackする必要がありましたが
[^2]: のちにGradleでの差分ビルドも試しましたが、いまのところEclipseの方が高速です

## 効果
プレマージチェックを導入したことで以下のような効果がでました。

* developブランチにコンパイルエラー、Lintエラーが混入することがほぼなくなった
* 以下のようなエラーをコードレビュー前に開発者が自主的に気づいて直せるようになった
  * ファイルのコミット漏れ
  * 不要になったメソッド、変数の削除漏れ
  * サブクラスで既に定義されているメソッドと同名のメソッド、フィールドを親クラスに追加してしまうミス

また、プレマージチェックに失敗するとSlackのチャンネルに ~~レビュワーと開発者の名前が晒される~~ レビュワーと開発者に通知が飛ぶようにしたため、CIに怒られないようにしようという意識が開発者全体に浸透しました。

その結果、懸念であった、エラーが放置されたり、修正前にマージされたりということは起こりませんでした。
